C51 COMPILER V9.00   I2C_C                                                                 07/03/2013 16:45:11 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE I2C_C
OBJECT MODULE PLACED IN ..\obj\I2C_C.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\user\I2C_C.c BROWSE INCDIR(..\code;..\user) DEBUG OBJECTEXTEND PRINT(..\
                    -obj\I2C_C.lst) OBJECT(..\obj\I2C_C.obj)

line level    source

   1          /***************************飞音云电子****************************
   2          **  工程名称：YS-XFS5152语音合成配套程序
   3          **      CPU: STC89LE52
   4          **      晶振：22.1184MHZ
   5          **      波特率：9600 bit/S
   6          **      配套产品信息：YS-XFS5051语音合成模块
   7          **                http://yuesheng001.taobao.com
   8          **  作者：zdings
   9          **  联系：751956552@qq.com
  10          **  修改日期：2012.12.23
  11          **  说明：用户在使用程序时，只需要编写好 串口发送函数PrintCom()；即可，
  12                   直接调用本文件进行播放即可，在编写程序时，注意判断语音合成模
  13                                           块的返回值，根据返回值进行下一次播放，如不接收返回值则无法进
  14                                           行下一次播放。
  15          /***************************飞音云电子******************************/
  16          #include "config.h"
  17          #include <intrins.h>
  18          #define uchar unsigned char
  19          #define uint unsigned int
  20          
  21          sbit SDA=P2^3;//定义数据线
  22          sbit SCL=P2^2;//定义时钟线
  23          bit flag;
  24          //uint idata ucSendBuffer[8]={0x01,0x02,0x04,0x08,0x10,0x20,0x40,0x80};
  25          //uint idata ucReceData;
  26          //uint idata ucReceiveBuffer[8];//从器件中读出的多字节数据暂存区
  27          void delay();
  28          //void delay_10ms();
  29          //void ACK();
  30          //void NoACK();
  31          /* ********************************************************
  32          **名称：I2C_Start
  33          **功能：启动I2C
  34          **输入：无
  35          **返回：无
  36          ******************************************************* */
  37          void I2C_Start()
  38          {
  39   1        SDA=1;
  40   1        _nop_();
  41   1        SCL=1;
  42   1        _nop_();
  43   1        _nop_();
  44   1        _nop_();
  45   1        _nop_();
  46   1        SDA=0;
  47   1        _nop_();
  48   1        _nop_();
  49   1        _nop_();
  50   1        _nop_();
  51   1        SCL=0;//钳位I2C总线，准备发送数据
  52   1      
  53   1      }
  54          /**********************************************************
C51 COMPILER V9.00   I2C_C                                                                 07/03/2013 16:45:11 PAGE 2   

  55          **名称：I2C_Stop
  56          **功能：停止I2C
  57          **输入：无
  58          **返回：无
  59          **********************************************************/
  60          void I2C_Stop()
  61          {
  62   1        SDA=0;
  63   1          _nop_();
  64   1               _nop_();
  65   1        SCL=1;
  66   1        _nop_();
  67   1        _nop_();
  68   1        _nop_();
  69   1        _nop_();
  70   1         SDA=1;
  71   1      
  72   1      }
  73          
  74          /********************************************************
  75          **名称：Test_Ack()
  76          **功能：检测应答位
  77          *********************************************************/
  78          bit Test_Ack()
  79          { 
  80   1        SCL=0;
  81   1        delay();
  82   1        SDA=1;//读入数据
  83   1        delay();
  84   1        SCL=1;
  85   1        delay();
  86   1        if(SDA==0)
  87   1        flag=1;
  88   1        else flag=0;
  89   1        SCL=0;
  90   1        return(flag);
  91   1      }
  92          
  93          /********************************************************
  94          **名称：SendData()  
  95          **功能：发送一字节数据
  96          **输入：buffer
  97          **返回：
  98          *******************************************************/
  99          void SendData(uint8_t buffer)
 100          {
 101   1        uint BitCnt=8;//一字节8位
 102   1        uint temp=0;
 103   1        do
 104   1        {
 105   2                temp=buffer;
 106   2                SCL=0;
 107   2                //delay();
 108   2                if((temp&0x80)==0) //判断最高位是0还是1
 109   2                {
 110   3                      SDA=0;
 111   3                }
 112   2                else
 113   2                {
 114   3                      SDA=1;
 115   3                }
 116   2                 delay();
C51 COMPILER V9.00   I2C_C                                                                 07/03/2013 16:45:11 PAGE 3   

 117   2                 delay();
 118   2                SCL=1;
 119   2                //delay();
 120   2                temp=buffer<<1;
 121   2                buffer=temp;
 122   2                BitCnt--;
 123   2        }
 124   1        while(BitCnt);
 125   1        SCL=0;  
 126   1      }
 127          /************************************************************************
 128          功能描述：      发送多字节数据
 129          入口参数：      DAT:带发送的数据
 130          返 回 值：      none
 131          其他说明：suba-数据地址，*s-写入的数据，n-写入的字节数
 132          **************************************************************************/
 133          uint8_t I2CSendData(uint8_t s[],uint8_t n)
 134          {
 135   1        uint i;
 136   1        I2C_Start();//启动I2C
 137   1        SendData(0x80);//发送器件地址
 138   1      
 139   1        Test_Ack();
 140   1        if(flag==0) return(0);
 141   1      
 142   1        for(i=0;i<n;i++)
 143   1        {
 144   2              SendData(s[i]);
 145   2          Test_Ack();
 146   2              if(flag==0) return(0);
 147   2        }
 148   1        I2C_Stop();
 149   1        return(1);
 150   1      }
 151          
 152          
 153          void delay()
 154          {
 155   1        uint i;
 156   1        for(i=10;i>0;i--)
 157   1        {
 158   2              _nop_();
 159   2        }      
 160   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    219    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       9
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
