C51 COMPILER V9.00   USART                                                                 01/08/2013 09:36:46 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE USART
OBJECT MODULE PLACED IN ..\obj\usart.obj
COMPILER INVOKED BY: C:\Program Files\keil 4\C51\BIN\C51.EXE ..\user\usart.c BROWSE INCDIR(..\code;..\user) DEBUG OBJECT
                    -EXTEND PRINT(..\..\usart.lst) TABS(2) OBJECT(..\obj\usart.obj)

line level    source

   1          /***************************F飞音云电子****************************
   2          **  工程名称:串口通讯函数
   3          **  CPU: STC89LE52
   4          **  晶振：22.1184MHZ
   5          **  波特率：9600 bit/S
   6          **  配套产品信息：XFS5051语音合成模块
   7          **                http://yuesheng001.taobao.com
   8          **  作者：zdings
   9          **  联系：751956552@qq.com
  10          **  修改日期：2012.12.23
  11          **  说明：
  12          /***************************飞音云电子******************************/
  13          #include "config.h"
  14          
  15          extern uint8_t tim_flag; //1:时间到标志
  16          extern uint16_t tim_cnt; //定时器计数值
  17          uint8_t UART_Rbuf[3]=0;
  18          uint8_t UART_Rcnt=0; //串口帧头接收计数器
  19          
  20          uint8_t xdata UART_TXTbuf[80]=0;
  21          uint8_t UART_TXTcnt=0; //串口文本接收计数器
  22          
  23          uint8_t Sign_Ture[3]=0;//信号是否为真判断，1：帧头正确。2：地址高位正确3：地址地位正确
  24          uint8_t Sign_flag=0;//信号标志，0：接收帧头，1：接收文本
  25          /************************************************************************
  26          函 数 名： 串口初始化
  27          功能描述： STC89LE52单片机串口初始化函数
  28          返回函数： none
  29          其他说明： none
  30          **************************************************************************/
  31          void UartIni(void)
  32          {
  33   1        
  34   1        SCON = 0x50 ; //SCON: serail mode 1, 8-bit UART, enable ucvr  
  35   1        
  36   1        TMOD |= 0x20 ; //TMOD: timer 1, mode 2, 8-bit reload 
  37   1        
  38   1        PCON |= 0x80 ; //SMOD=1; 
  39   1        
  40   1        TH1 = 0xF4 ; //Baud:9600 fosc=22.1148MHz 
  41   1        
  42   1        IE |= 0x90 ; //Enable Serial Interrupt 
  43   1        
  44   1        TR1 = 1 ; // timer 1 run 
  45   1        ES=1;
  46   1        EA=1;
  47   1      }
  48          
  49          /***********************************************************
  50          * 名    称： 串口接收中断
  51          * 功    能： 
  52          * 入口参数： 无 
  53          * 出口参数：无
  54          * 说    明：           
C51 COMPILER V9.00   USART                                                                 01/08/2013 09:36:46 PAGE 2   

  55          **********************************************************/
  56          void Uart_Isr() interrupt 4 using 1
  57          { 
  58   1        if(RI)
  59   1        { 
  60   2          ES=0;
  61   2          RI=0;
  62   2          //帧头接收
  63   2          if(Sign_flag==0)
  64   2          { 
  65   3                  
  66   3            UART_Rbuf[UART_Rcnt]=SBUF;  
  67   3            UART_Rcnt++;
  68   3            tim_cnt=50;   //50ms 后重置计数器
  69   3            TR0=1;       //开启定时
  70   3            
  71   3            if(UART_Rcnt<=3)
  72   3            {
  73   4               if(UART_Rbuf[0]==0XFD && UART_Rcnt==1) Sign_Ture[0]=1;
  74   4               else if(UART_Rbuf[1]==0Xf0 && Sign_Ture[0]==1 && UART_Rcnt==2) Sign_Ture[1]=2;
  75   4               else if(UART_Rbuf[2]==0X01 && Sign_Ture[1]==2 && UART_Rcnt==3)
  76   4                {
  77   5                Sign_Ture[2]=3;
  78   5                Sign_flag=1;
  79   5                memset(UART_TXTbuf,0,22);
  80   5                UART_Rcnt=0;
  81   5              }
  82   4              else 
  83   4               {
  84   5                  TR0=0;         //停止定时 
  85   5                  UART_Rcnt=0;
  86   5                  memset(UART_Rbuf,0,3);
  87   5               }
  88   4             }    
  89   3           }
  90   2           //文本接收
  91   2           else 
  92   2           {
  93   3            UART_TXTbuf[UART_TXTcnt]=SBUF;  
  94   3            UART_TXTcnt++;
  95   3            tim_cnt=50;   //50ms 后重置计数器
  96   3            TR0=1;       //开启定时
  97   3            memset(UART_Rbuf,0,3);      
  98   3             if(UART_TXTcnt==79 )     //接收到一定长度后清除标志
  99   3            { 
 100   4              TR0=0;         //停止定时
 101   4              tim_flag=1;    //定时到
 102   4              UART_TXTcnt=0;
 103   4              Sign_flag=0;
 104   4            }
 105   3           }
 106   2            ES=1;
 107   2        }
 108   1      
 109   1      }
 110          /************************************************************************
 111          功能描述：  串口发送一字节数据
 112          入口参数：  DAT:带发送的数据
 113          返 回 值：  none
 114          其他说明：  none
 115          **************************************************************************/
 116          void UARTSendByte(uint8_t DAT)
C51 COMPILER V9.00   USART                                                                 01/08/2013 09:36:46 PAGE 3   

 117          {
 118   1        ES  =  0;
 119   1        TI=0;
 120   1        SBUF = DAT;
 121   1        while(TI==0);
 122   1        TI=0;
 123   1        ES = 1;
 124   1      }
 125          
 126          /************************************************************************
 127          功能描述： 串口发送字符串数据
 128          入口参数：  *DAT：字符串指针
 129          返 回 值： none
 130          其他说明： API 供外部使用，直观！
 131          **************************************************************************/
 132          void PrintCom(uint8_t *DAT,uint8_t len)
 133          {
 134   1        uint8_t i;
 135   1        for(i=0;i<len;i++)
 136   1        {
 137   2          UARTSendByte(*DAT++);
 138   2        } 
 139   1      }
 140          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    299    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     80    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      9       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
