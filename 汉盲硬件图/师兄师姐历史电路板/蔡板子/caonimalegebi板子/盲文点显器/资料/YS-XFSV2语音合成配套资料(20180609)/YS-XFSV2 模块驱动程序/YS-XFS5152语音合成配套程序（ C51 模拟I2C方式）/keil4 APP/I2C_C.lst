C51 COMPILER V9.00   I2C_C                                                                 01/08/2013 09:36:46 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE I2C_C
OBJECT MODULE PLACED IN ..\obj\I2C_C.obj
COMPILER INVOKED BY: C:\Program Files\keil 4\C51\BIN\C51.EXE ..\user\I2C_C.c BROWSE INCDIR(..\code;..\user) DEBUG OBJECT
                    -EXTEND PRINT(..\..\I2C_C.lst) TABS(2) OBJECT(..\obj\I2C_C.obj)

line level    source

   1          /***********************************************************
   2          **模块名称：24C02的读写
   3          **编写人：bradley 日期 2005－5－1
   4          **修改人：bradley
   5          **功能描述：将8字节数据写入24C02中，然后再读出来送P1口显示
   6          **其他说明：本程序是采用24C02的页面写入连续读写8字节数据
   7          **版本：keil 7.0*/
   8          #include "config.h"
   9          #include <intrins.h>
  10          #define uchar unsigned char
  11          #define uint unsigned int
  12          sbit SDA=P2^1;//定义数据线
  13          sbit SCL=P2^2;//定义时钟线
  14          bit flag;
  15          //uint idata ucSendBuffer[8]={0x01,0x02,0x04,0x08,0x10,0x20,0x40,0x80};
  16          //uint idata ucReceData;
  17          //uint idata ucReceiveBuffer[8];//从器件中读出的多字节数据暂存区
  18          void delay();
  19          //void delay_10ms();
  20          //void ACK();
  21          //void NoACK();
  22          /* ********************************************************
  23          **名称：I2C_Start
  24          **功能：启动I2C
  25          **输入：无
  26          **返回：无
  27          ******************************************************* */
  28          void I2C_Start()
  29          {
  30   1        SDA=1;
  31   1        _nop_();
  32   1        SCL=1;
  33   1        _nop_();
  34   1        _nop_();
  35   1        _nop_();
  36   1        _nop_();
  37   1        SDA=0;
  38   1        _nop_();
  39   1        _nop_();
  40   1        _nop_();
  41   1        _nop_();
  42   1        SCL=0;//钳位I2C总线，准备发送数据
  43   1      
  44   1      }
  45          /**********************************************************
  46          **名称：I2C_Stop
  47          **功能：停止I2C
  48          **输入：无
  49          **返回：无
  50          **********************************************************/
  51          void I2C_Stop()
  52          {
  53   1        SDA=0;
  54   1          _nop_();
C51 COMPILER V9.00   I2C_C                                                                 01/08/2013 09:36:46 PAGE 2   

  55   1         _nop_();
  56   1        SCL=1;
  57   1        _nop_();
  58   1        _nop_();
  59   1        _nop_();
  60   1        _nop_();
  61   1         SDA=1;
  62   1      
  63   1      }
  64          
  65          /********************************************************
  66          **名称：Test_Ack()
  67          **功能：检测应答位
  68          *********************************************************/
  69          bit Test_Ack()
  70          { 
  71   1        SCL=0;
  72   1        delay();
  73   1        SDA=1;//读入数据
  74   1        delay();
  75   1        SCL=1;
  76   1        delay();
  77   1        if(SDA==0)
  78   1        flag=1;
  79   1        else flag=0;
  80   1        SCL=0;
  81   1        return(flag);
  82   1      }
  83          
  84          /********************************************************
  85          **名称：SendData()  
  86          **功能：发送一字节数据
  87          **输入：buffer
  88          **返回：
  89          *******************************************************/
  90          void SendData(uint8_t buffer)
  91          {
  92   1        uint BitCnt=8;//一字节8位
  93   1        uint temp=0;
  94   1        do
  95   1        {
  96   2          temp=buffer;
  97   2          SCL=0;
  98   2          //delay();
  99   2          if((temp&0x80)==0) //判断最高位是0还是1
 100   2          {
 101   3            SDA=0;
 102   3          }
 103   2          else
 104   2          {
 105   3            SDA=1;
 106   3          }
 107   2           delay();
 108   2           delay();
 109   2          SCL=1;
 110   2          //delay();
 111   2          temp=buffer<<1;
 112   2          buffer=temp;
 113   2          BitCnt--;
 114   2        }
 115   1        while(BitCnt);
 116   1        SCL=0;  
C51 COMPILER V9.00   I2C_C                                                                 01/08/2013 09:36:46 PAGE 3   

 117   1      }
 118          /************************************************************************
 119          功能描述：  发送多字节数据
 120          入口参数：  DAT:带发送的数据
 121          返 回 值：  none
 122          其他说明：suba-数据地址，*s-写入的数据，n-写入的字节数
 123          **************************************************************************/
 124          uint8_t I2CSendData(uint8_t s[],uint8_t n)
 125          {
 126   1        uint i;
 127   1        I2C_Start();//启动I2C
 128   1        SendData(0x80);//发送器件地址
 129   1      
 130   1        Test_Ack();
 131   1        if(flag==0) return(0);
 132   1      
 133   1        for(i=0;i<n;i++)
 134   1        {
 135   2          SendData(s[i]);
 136   2          Test_Ack();
 137   2          if(flag==0) return(0);
 138   2        }
 139   1        I2C_Stop();
 140   1        return(1);
 141   1      }
 142          
 143          
 144          void delay()
 145          {
 146   1        uint i;
 147   1        for(i=10;i>0;i--)
 148   1        {
 149   2          _nop_();
 150   2        }  
 151   1      }
 152          ///**********************************************************
 153          //**名称：Ack
 154          //**功能：应答信号
 155          //**输入：无
 156          //**返回：无
 157          //**********************************************************/
 158          //void Ack()
 159          //{
 160          //  SDA=0;
 161          //  delay();
 162          //  SCL=1;
 163          //  delay();
 164          //  SCL=0;
 165          //  delay();
 166          //  SDA=1;
 167          //  delay();
 168          //}
 169          ///********************************************************
 170          //**名称：NoAck
 171          //**功能：发送非应答信号
 172          //**输入：无
 173          //**返回：无
 174          //********************************************************/
 175          //void NoAck()
 176          //{
 177          //  SDA=1;
 178          //  delay();
C51 COMPILER V9.00   I2C_C                                                                 01/08/2013 09:36:46 PAGE 4   

 179          //  SCL=1;
 180          //  delay();
 181          //  SCL=0;
 182          //  delay();
 183          //  SDA=0;
 184          //  delay();
 185          //}
 186          ///**************************************************************
 187          //**名称：uint ReceiveData()
 188          //**功能：接收一字节数据
 189          //**输入：
 190          //**返回：ucReceData
 191          //**说明：将接收的数据存放在ucReceData中
 192          //**************************************************************/
 193          //uint ReceiveData()
 194          //{
 195          //  uint BitCnt=8;
 196          //  uint temp=0;
 197          //  SDA=1;//读入数据
 198          //  do
 199          //  {
 200          //  SCL=0;
 201          //  delay();
 202          //  SCL=1;
 203          //  delay();
 204          //  if(SDA==1)
 205          //  ucReceData=ucReceData|0x01;//低位置1
 206          //  else
 207          //  ucReceData=ucReceData&0x0fe;//低位清0
 208          //  if(BitCnt-1)
 209          //  {
 210          //  temp=_crol_(ucReceData,1);//数据左移一位
 211          //  ucReceData=temp;
 212          //  }
 213          //  BitCnt--;
 214          //  }
 215          //  while(BitCnt);
 216          //  SCL=0;
 217          //  return(ucReceData);
 218          //}
 219          
 220          ///*************************************************************
 221          //**名称：bit WriteNByte()
 222          //**功能：向24C02中写入多字节数据
 223          //**输入：
 224          //**返回：
 225          //**说明：sla-器件地址 suba-数据地址，*s-写入的数据，n-写入的字节数
 226          //  (n<=8)
 227          //**************************************************************/
 228          //bit WriteNByte(uint sla,uint suba,uint s[],uint n)
 229          //{
 230          //  uint i;
 231          //  I2C_Start();//启动I2C
 232          //  SendData(sla);//发送器件地址
 233          //  Test_Ack();
 234          //  if(flag==0) return(0);
 235          //  SendData(suba);
 236          //  Test_Ack();
 237          //  if(flag==0) return(0);
 238          //  for(i=0;i<n;i++)//写入8字节数据
 239          //  {
 240          //  SendData(s[i]);
C51 COMPILER V9.00   I2C_C                                                                 01/08/2013 09:36:46 PAGE 5   

 241          //    Test_Ack();
 242          //  if(flag==0) return(0);
 243          //  }
 244          //  I2C_Stop();
 245          //  return(1);
 246          //}
 247          ///*************************************************************
 248          //**名称：bit ReadNByte()
 249          //**功能：从24C02中读出N字节数据（n<=8)
 250          //**输入：
 251          //**返回：
 252          //**说明：
 253          //**************************************************************/
 254          //bit ReadNByte(uint sla,uint suba,uint p[],uint n)
 255          //{
 256          //  uint i;
 257          //  I2C_Start();//启动I2C
 258          //  SendData(sla);//发送器件地址
 259          //  Test_Ack();
 260          //  if(flag==0) return(0);
 261          //  SendData(suba);//发送器件内部地址
 262          //  Test_Ack();
 263          //  if(flag==0) return(0);
 264          //  I2C_Start();
 265          //  SendData(sla+1);
 266          //  Test_Ack();
 267          //  if(flag==0) return(0);
 268          //  for(i=0;i<n-2;i++)//读取字节数据
 269          //  {
 270          //  p[i]=ReceiveData();//读取数据
 271          //  ACK();
 272          //  }
 273          //  p[n-1]=ReceiveData();
 274          //  NoACK();
 275          //  I2C_Stop();
 276          //  return(1);
 277          //}
 278          /***************************************************************
 279          **名称：main()
 280          **功能：
 281          **输入：
 282          **返回：
 283          **说明：
 284          ****************************************************************/
 285          //void main()
 286          //{ uint j;
 287          //  bit bp;
 288          //  P1=0x0e;//上电时点亮LED
 289          //  do
 290          //  {
 291          //  bp=WriteNByte(0xae,0x00,ucSendBuffer,8);//写入数据
 292          //  }
 293          //  while(~bp);
 294          //  delay_10ms();
 295          //  do
 296          //  {
 297          //  bp=ReadNByte(0xae,0x00,ucReceiveBuffer,8);//读出数据
 298          //  }
 299          //  while(~bp);
 300          //  while(1)
 301          //  {
 302          //  for(j=0;j<8;j++)
C51 COMPILER V9.00   I2C_C                                                                 01/08/2013 09:36:46 PAGE 6   

 303          //  {
 304          //  P1=ucReceiveBuffer[4];//将从24C02中读出的数据送LED显示
 305          //  delay_10ms();
 306          //  }
 307          //}
 308          //}  
 309          
 310          
 311          
 312          //void delay_10ms()
 313          //{
 314          //  uint i,j;
 315          //  for(i=100;i>0;i--)
 316          //  { for(j=250;j>0;j--)
 317          //  _nop_();
 318          //
 319          //  }
 320          //}
 321          
 322          //本程序采用软件延时的方法产生SCL脉冲，为保证有足够的延时，特延时100us，在使用时可根据要求适当调整。（如12
             -M晶振时，只要>4.7us即可）


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    219    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       9
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
